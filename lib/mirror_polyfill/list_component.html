<!-- Copyright (c) 2012, the Dart project authors.  Please see the AUTHORS file
     for details. All rights reserved. Use of this source code is governed by a
     BSD-style license that can be found in the LICENSE file. -->
<!doctype html>
<html lang="en">
<head>
<script type="application/dart">
#import('dart:mirrors');
#import('dart:html');
#import("package:web_components/watcher.dart");
#import("package:web_components/mirror_polyfill/component.dart");
#import("package:web_components/mirror_polyfill/component_loader.dart");
</script>
</head>
<body>
<element name="x-list" extends="template" constructor="ListComponent"
         apply-author-styles>
  <template>
    <template iterate="i in items">
      <content></content>
    </template>
  </template>
  <script type="application/dart">

  String _loopVar;
  String _loopItems;
  Element _childTemplate;
  Element _parent;
  WatcherDisposer _stopWatcher;

  List items() => mirrorGet(declaringScope, _loopItems).reflectee;

  void created(ShadowRoot root) {
    super.created(root);
    var match = const RegExp(@"{{(.*) in (.*)}}").firstMatch(
          element.attributes['iterate']);
    _loopVar = match.group(1);
    _loopItems = match.group(2);

    // TODO(sigmund): support document fragments, not just a single child.
    // TODO(sigmund): use logging and not assertions.
    assert(element.elements.length == 1);
    _childTemplate = element.elements[0];
    element.nodes.clear();
    _parent = element.parent;
  }

  void inserted() {
    root.nodes.clear();
    _stopWatcher = bind(items, (_) {
      for (var n in _parent.elements) {
        var wrapper = manager[n];
        if (wrapper != this) {
          if (wrapper != null) wrapper.removed();
          n.remove();
        }
      }
      for (var item in items()) {
        var child = _childTemplate.clone(true);
        // TODO(jmesserly): should support children that aren't WebComponents
        manager.expandDeclarations(child,
            new ComponentScope(declaringScope, new Map()..[_loopVar] = item));

        _parent.nodes.add(child);
      }
    });
  }

  void removed() {
    _stopWatcher();
    for (var n in _parent.elements) {
      var wrapper = manager[n];
      if (wrapper != null && wrapper != this) {
        wrapper.removed();
      }
    }
  }
  </script>
</element>
</body>
</html>
