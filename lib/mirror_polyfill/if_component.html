<!-- Copyright (c) 2012, the Dart project authors.  Please see the AUTHORS file
     for details. All rights reserved. Use of this source code is governed by a
     BSD-style license that can be found in the LICENSE file. -->
<!doctype html>
<html lang="en">
<head>
<script type="application/dart">
#import('dart:html');
#import("package:web_components/watcher.dart");
#import("package:web_components/mirror_polyfill/component.dart");
#import("package:web_components/mirror_polyfill/component_loader.dart");
</script>
</head>
<body>
<element name="x-if" extends="template" constructor="IfComponent"
         apply-author-styles>
  <template>
    <content></content>
  </template>
  <script type="application/dart">
  Element _childTemplate;
  // TODO(jacobr): should this be removed?
  Element _parent;
  Element _child;
  String _childId;
  WatcherDisposer _stopWatcher;
  String condition;

  void created(ShadowRoot root) {
    // TODO(jacobr): calling super.created is wrong.
    super.created(root);

    condition = attributes['instantiate'].substring('if '.length);

    // TODO(sigmund): support document fragments, not just a single child.
    // TODO(sigmund): use logging and not assertions.
    assert(element.elements.length == 1);
    _childTemplate = element.elements[0];
    _childId = _childTemplate.id;
    if (_childId != null && _childId != '') {
      _childTemplate.id = '';
    }
    element.style.display = 'none';
    element.nodes.clear();
  }

  bool shouldShow() => mirrorGet(declaringScope, condition).reflectee;

  void inserted() {
    _stopWatcher = bind(() => shouldShow(), (e) {
      bool showNow = e.newValue;
      if (_child != null && !showNow) {
        _child.remove();
        _child = null;
      } else if (_child == null && showNow) {
        _child = _childTemplate.clone(true);
        if (_childId != null && _childId != '') {
          _child.id = _childId;
        }
        manager.expandDeclarations(_child, declaringScope);
        if (parent == null || parent.nodes == null) {
          window.console.error("Called inserted but parent node is null!");
        } else {
          parent.nodes.add(_child);
        }
      }
    });
  }

  void removed() {
  	if (_stopWatcher != null) {
      _stopWatcher();
    }
    if (_child != null) {
      _child.remove();
    }
  }

  String toString() => "Component $name <$id>";
  </script>
</element>
</body>
</html>
